set procedure to .\api.prg additive

class TranslateDB Of DATABASE
	with(this)
		databasename = 'TranslateDB'
		loginstring = 'SYSDBA/masterkey'
		active = True
	endwith
endclass

// Classe che gestisce la tabella outputstrings
// File				:			translate.prg
class Outputstrings()
	this.oDb = new translatedb()
	this.q = new query()
	this.q.database = this.oDb
	this.q.sql = 'SELECT * FROM OUTPUTSTRINGS'
	this.q.active = True

	// Cosa fa		:			Inserisce i dati nella tabella
	// pr_sFile		:			stringa, percorso del file
	// pr_sFunction:			stringa, nome della funzione
	// pr_nRiga		:			numerico, numero della riga
	// pr_sRiga		:			stringa, riga da inserire
	// Ritorna		:			lc_bRet, true se inserimento riuscito, altrimenti false
	// File			:			translate.prg
	function insertTb(pr_sFile,pr_sFunction,pr_nRiga,pr_sRiga)
		local lc_sFile,lc_sFunction,lc_nRiga,lc_sRiga,lc_sSql,lc_bRet
		
		lc_sFile = pr_sFile
		lc_sFunction = pr_sFunction
		lc_nRiga = pr_nRiga
		lc_sRiga = pr_sRiga
		lc_bRet = False
		
		this.q.rowset.beginAppend()
		this.q.rowset.fields['sFile'].Value = lc_sFile
		this.q.rowset.fields['sFunction'].Value = lc_sFunction
		this.q.rowset.fields['nRiga'].Value = lc_nRiga
		this.q.rowset.fields['sRiga'].Value = lc_sRiga
		// Cosa fa			:			Genera l'md5 di una stringa di testo
		// pr_sStringa		:			stringa, stringa di testo dalla quale generare l'md5
		// Ritorna			:			lc_sRet -> stringa, md5 della stringa
		// File				:			api.prg
		this.q.rowset.fields['sHash'].Value = Md5(lc_sRiga)
		this.q.rowset.save()
		
		try
			lc_bRet = True
		catch(Exception e)
			return lc_bRet
		endtry

		return lc_bRet

	// Cosa fa			:			Genera l'hash (firebird sql) della colonna sRiga, per ogni riga nella tabella e lo salva in sHash
	function md5()
		local lc_sSql
		lc_sSql = 'UPDATE TABLE OUTPUTSTRINGS SET SHASH=HASH(SRIGA)'
		this.oDb.executesql(lc_sSql)
		return
		
	// Cosa fa			:			Chiude la connessione al db, rilasciando l'oggetto this.oDb e this.q
	function releaseConnection()
		this.q.active = False
		release object this.q
		this.q = NULL
	
		this.oDb.active = False
		release object this.oDb
		this.oDb = NULL
		return
endclass